"use strict";(self["webpackChunkmeiban_app"]=self["webpackChunkmeiban_app"]||[]).push([[829],{87829:(e,t,r)=>{r.r(t),r.d(t,{API_CONFIG:()=>s,checkApiHealth:()=>b,fetchAstrologyData:()=>w,getApiConfig:()=>A,setApiToken:()=>v});var n=r(14048),a=r(30388),o=r(78676),c=(r(16280),r(76918),r(28706),r(51629),r(23288),r(62010),r(18111),r(7588),r(5506),r(79432),r(26099),r(38781),r(47764),r(68156),r(23500),r(62953),r(76031),r(48408),r(14603),r(47566),r(98721),r(23171)),s={baseUrl:"https://xingpan-proxy.kidyuan.workers.dev",defaultParams:{h_sys:"P",planets:["0","1","2","3","4","5","6","7","8","9","t"],virtual:["10"],phase:{0:0,30:2,36:2,45:2,60:6,72:2,90:6,120:6,135:.5,144:2,150:2,180:6},ay:"-1",tomorrow_type:"1",svg_type:"1"},timeout:15e3,maxRetries:2};function i(e,t,r){var n=String(t||0).padStart(2,"0"),a=String(r||0).padStart(2,"0");return"".concat(e," ").concat(n,":").concat(a)}function u(e){try{var t=(0,c.pk)(e);return t&&t.lat&&t.lng?{latitude:t.lat,longitude:t.lng}:(console.warn("未找到 ".concat(e," 的坐标信息，使用默认坐标")),{latitude:29.13,longitude:121.03})}catch(r){return console.error("获取坐标信息失败:",r),{latitude:29.13,longitude:121.03}}}function l(e){var t=e.birthdate,r=e.birthHour,n=e.birthMinute,a=e.birthplace,c=u(a),l=i(t,r,n),p={longitude:c.longitude.toString(),latitude:c.latitude.toString(),tz:"8.00",h_sys:s.defaultParams.h_sys,birthday:l,ay:s.defaultParams.ay,tomorrow_type:s.defaultParams.tomorrow_type,svg_type:s.defaultParams.svg_type};return s.defaultParams.planets.forEach((function(e,t){p["planets[".concat(t,"]")]=e})),s.defaultParams.virtual.forEach((function(e,t){p["virtual[".concat(t,"]")]=e})),Object.entries(s.defaultParams.phase).forEach((function(e){var t=(0,o.A)(e,2),r=t[0],n=t[1];p["phase[".concat(r,"]")]=n})),p}function p(e){return h.apply(this,arguments)}function h(){return h=(0,a.A)((0,n.A)().mark((function e(t){var r,a,c,i,u,l;return(0,n.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=new AbortController,a=setTimeout((function(){return r.abort()}),s.timeout),e.prev=2,c=new URLSearchParams,Object.entries(t).forEach((function(e){var t=(0,o.A)(e,2),r=t[0],n=t[1];c.append(r,n)})),console.log("🚀 发送星盘API请求 (通过Cloudflare Worker):",s.baseUrl),console.log("📋 请求参数:",t),console.log("📤 请求体 (form-data):",c.toString()),e.next=10,fetch(s.baseUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Origin:window.location.origin},body:c,signal:r.signal});case 10:if(i=e.sent,clearTimeout(a),i.ok){e.next=14;break}throw new Error("API请求失败: ".concat(i.status," ").concat(i.statusText));case 14:return e.next=16,i.text();case 16:u=e.sent,console.log("📥 原始响应:",u),e.prev=18,l=JSON.parse(u),e.next=26;break;case 22:throw e.prev=22,e.t0=e["catch"](18),console.error("❌ JSON解析失败:",e.t0),new Error("响应解析失败: ".concat(u));case 26:if(console.log("✅ API响应成功"),console.log("📦 响应数据:",l),0===l.code){e.next=30;break}throw new Error("API返回错误 (code: ".concat(l.code,"): ").concat(l.msg||"未知错误"));case 30:return e.abrupt("return",l);case 33:if(e.prev=33,e.t1=e["catch"](2),clearTimeout(a),"AbortError"!==e.t1.name){e.next=38;break}throw new Error("API请求超时");case 38:throw console.error("❌ API请求失败:",e.t1),e.t1;case 40:case"end":return e.stop()}}),e,null,[[2,33],[18,22]])}))),h.apply(this,arguments)}function f(e){return d.apply(this,arguments)}function d(){return d=(0,a.A)((0,n.A)().mark((function e(t){var r,a,o,c,i;return(0,n.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:r=l(t),o=(0,n.A)().mark((function e(){var t,o;return(0,n.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,console.log("🔄 API调用尝试 ".concat(i,"/").concat(s.maxRetries)),e.next=4,p(r);case 4:return t=e.sent,e.abrupt("return",{v:t});case 8:if(e.prev=8,e.t0=e["catch"](0),a=e.t0,!(i<s.maxRetries)){e.next=16;break}return o=1e3*Math.pow(2,i),console.warn("⚠️ 第".concat(i,"次尝试失败，").concat(o,"ms后重试:"),e.t0.message),e.next=16,new Promise((function(e){return setTimeout(e,o)}));case 16:case"end":return e.stop()}}),e,null,[[0,8]])})),i=1;case 3:if(!(i<=s.maxRetries)){e.next=11;break}return e.delegateYield(o(),"t0",5);case 5:if(c=e.t0,!c){e.next=8;break}return e.abrupt("return",c.v);case 8:i++,e.next=3;break;case 11:throw console.error("❌ API调用失败，已达到最大重试次数 (".concat(s.maxRetries,"):"),a),a;case 13:case"end":return e.stop()}}),e)}))),d.apply(this,arguments)}function w(e){return m.apply(this,arguments)}function m(){return m=(0,a.A)((0,n.A)().mark((function e(t){var r;return(0,n.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,t&&t.birthdate&&t.birthplace){e.next=3;break}throw new Error("缺少必要的出生信息（日期和地点）");case 3:return console.log("🌟 开始获取星盘数据"),console.log("👤 用户数据:",t),e.next=7,f(t);case 7:if(r=e.sent,r.data){e.next=10;break}throw new Error("API返回数据格式错误");case 10:return console.log("🎯 星盘数据获取成功"),e.abrupt("return",r.data);case 14:throw e.prev=14,e.t0=e["catch"](0),console.error("🚫 获取星盘数据失败:",e.t0),new Error("星盘API调用失败: ".concat(e.t0.message));case 18:case"end":return e.stop()}}),e,null,[[0,14]])}))),m.apply(this,arguments)}function b(){return g.apply(this,arguments)}function g(){return g=(0,a.A)((0,n.A)().mark((function e(){var t;return(0,n.A)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t={birthdate:"1981-11-17",birthHour:0,birthMinute:50,birthplace:"浙江省台州市天台县"},e.next=4,w(t);case 4:return e.abrupt("return",!0);case 7:return e.prev=7,e.t0=e["catch"](0),console.error("API健康检查失败:",e.t0),e.abrupt("return",!1);case 11:case"end":return e.stop()}}),e,null,[[0,7]])}))),g.apply(this,arguments)}function v(){console.warn("⚠️ Worker 模式下 API 令牌由服务端管理，setApiToken 方法已无效")}function A(){return{baseUrl:s.baseUrl,timeout:s.timeout,maxRetries:s.maxRetries,proxyMode:"Cloudflare Worker",tokenManagement:"Server-side"}}}}]);
//# sourceMappingURL=829.ea432f85.js.map