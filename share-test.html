<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†äº«åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .test-result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .test-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .url-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ å¾®ä¿¡åˆ†äº«åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š æµ‹è¯•æ•°æ®</h2>
        <p>æˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•ï¼š</p>
        <pre id="testData"></pre>
    </div>

    <div class="test-section">
        <h2>ğŸ”— URL ç¼–ç æµ‹è¯•</h2>
        <button onclick="testUrlEncoding()">æµ‹è¯•æ•°æ®ç¼–ç </button>
        <button onclick="testUrlDecoding()">æµ‹è¯•æ•°æ®è§£ç </button>
        <div id="encodingResults"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“± åˆ†äº«é“¾æ¥ç”Ÿæˆæµ‹è¯•</h2>
        <button onclick="testShareUrlGeneration('astrology')">ç”Ÿæˆå æ˜Ÿåˆ†æåˆ†äº«é“¾æ¥</button>
        <button onclick="testShareUrlGeneration('bazi')">ç”Ÿæˆç”Ÿè¾°å…«å­—åˆ†äº«é“¾æ¥</button>
        <div id="shareResults"></div>
    </div>

    <div class="test-section">
        <h2>ğŸŒ å¾®ä¿¡ç¯å¢ƒæ£€æµ‹</h2>
        <button onclick="testWechatDetection()">æ£€æµ‹å¾®ä¿¡ç¯å¢ƒ</button>
        <div id="wechatResults"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h2>
        <ol>
            <li><strong>URLç¼–ç æµ‹è¯•</strong>ï¼šéªŒè¯æ•°æ®èƒ½å¦æ­£ç¡®ç¼–ç å’Œè§£ç </li>
            <li><strong>åˆ†äº«é“¾æ¥ç”Ÿæˆ</strong>ï¼šç”ŸæˆåŒ…å«æ•°æ®çš„åˆ†äº«é“¾æ¥</li>
            <li><strong>å¾®ä¿¡ç¯å¢ƒæ£€æµ‹</strong>ï¼šæ£€æµ‹å½“å‰æ˜¯å¦åœ¨å¾®ä¿¡æµè§ˆå™¨ä¸­</li>
            <li><strong>æ‰‹åŠ¨æµ‹è¯•</strong>ï¼šå¤åˆ¶ç”Ÿæˆçš„é“¾æ¥ï¼Œåœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€æµ‹è¯•</li>
        </ol>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿçš„æµ‹è¯•æ•°æ®
        const mockUserData = {
            name: "æµ‹è¯•ç”¨æˆ·",
            birthdate: "1990-03-15",
            birthHour: 14,
            birthMinute: 30,
            birthplace: "åŒ—äº¬",
            gender: "male",
            fullBirthDateTime: "1990-03-15T14:30:00.000Z"
        };

        const mockCalculationResults = {
            eightCharacters: {
                year: { heavenlyStem: "åºš", earthlyBranch: "åˆ" },
                month: { heavenlyStem: "å·±", earthlyBranch: "å¯" },
                day: { heavenlyStem: "ç™¸", earthlyBranch: "äº¥" },
                hour: { heavenlyStem: "å·±", earthlyBranch: "æœª" }
            },
            elements: ["é‡‘", "åœŸ", "æ°´", "åœŸ"],
            astrologyPositions: {
                ascendant: { sign: "åŒå­åº§", degree: 4, minute: 11 },
                sun: { sign: "åŒé±¼åº§", degree: 13, minute: 49 },
                moon: { sign: "æ°´ç“¶åº§", degree: 18, minute: 56 }
            },
            fortune: {
                overview: "å¤§å‰",
                career: "â˜…â˜…â˜…â˜†â˜†",
                wealth: "â˜…â˜…â˜…â˜…â˜†",
                love: "â˜…â˜…â˜…â˜…â˜…",
                health: "â˜…â˜…â˜…â˜†â˜†"
            }
        };

        // æ˜¾ç¤ºæµ‹è¯•æ•°æ®
        document.getElementById('testData').textContent = JSON.stringify({
            userData: mockUserData,
            calculationResults: mockCalculationResults
        }, null, 2);

        // åŠ¨æ€å¯¼å…¥æˆ‘ä»¬çš„å·¥å…·å‡½æ•°
        let dataEncoder, wechatShare;
        
        try {
            const modules = await Promise.all([
                import('./src/utils/dataEncoder.js'),
                import('./src/utils/wechatShare.js')
            ]);
            dataEncoder = modules[0];
            wechatShare = modules[1];
            console.log('âœ… å·¥å…·æ¨¡å—åŠ è½½æˆåŠŸ');
        } catch (error) {
            console.error('âŒ å·¥å…·æ¨¡å—åŠ è½½å¤±è´¥:', error);
            document.body.innerHTML += '<div class="test-error">âŒ å·¥å…·æ¨¡å—åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿é¡¹ç›®å·²æ­£ç¡®æ„å»º</div>';
        }

        // æµ‹è¯•å‡½æ•°
        window.testUrlEncoding = function() {
            const resultsDiv = document.getElementById('encodingResults');
            resultsDiv.innerHTML = '';

            try {
                const shareData = {
                    userData: mockUserData,
                    calculationResults: mockCalculationResults,
                    analysisType: 'astrology'
                };

                const encoded = dataEncoder.encodeDataForUrl(shareData);
                const urlLength = encoded.length;

                resultsDiv.innerHTML += `
                    <div class="test-result">
                        <strong>âœ… ç¼–ç æˆåŠŸ</strong><br>
                        ç¼–ç é•¿åº¦: ${urlLength} å­—ç¬¦<br>
                        URLé•¿åº¦æ˜¯å¦åˆç†: ${dataEncoder.isUrlLengthReasonable(`https://example.com/?data=${encoded}`) ? 'âœ… æ˜¯' : 'âŒ å¦'}
                    </div>
                    <div class="url-output">ç¼–ç ç»“æœ: ${encoded}</div>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="test-error">âŒ ç¼–ç å¤±è´¥: ${error.message}</div>`;
            }
        };

        window.testUrlDecoding = function() {
            const resultsDiv = document.getElementById('encodingResults');
            
            try {
                const shareData = {
                    userData: mockUserData,
                    calculationResults: mockCalculationResults,
                    analysisType: 'astrology'
                };

                const encoded = dataEncoder.encodeDataForUrl(shareData);
                const decoded = dataEncoder.decodeDataFromUrl(encoded);
                const isValid = dataEncoder.validateShareData(decoded);

                resultsDiv.innerHTML += `
                    <div class="test-result">
                        <strong>âœ… è§£ç æˆåŠŸ</strong><br>
                        æ•°æ®éªŒè¯: ${isValid ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ'}<br>
                        ç”¨æˆ·å§“å: ${decoded.userData?.name || 'æœªæ‰¾åˆ°'}<br>
                        åˆ†æç±»å‹: ${decoded.analysisType || 'æœªæ‰¾åˆ°'}
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="test-error">âŒ è§£ç å¤±è´¥: ${error.message}</div>`;
            }
        };

        window.testShareUrlGeneration = function(analysisType) {
            const resultsDiv = document.getElementById('shareResults');
            
            try {
                const shareUrl = dataEncoder.generateShareUrl(mockUserData, mockCalculationResults, analysisType);
                const shareContent = dataEncoder.generateShareContent(mockUserData, mockCalculationResults, analysisType);

                resultsDiv.innerHTML += `
                    <div class="test-result">
                        <strong>âœ… ${analysisType === 'astrology' ? 'å æ˜Ÿåˆ†æ' : 'ç”Ÿè¾°å…«å­—'}åˆ†äº«é“¾æ¥ç”ŸæˆæˆåŠŸ</strong><br>
                        æ ‡é¢˜: ${shareContent.title}<br>
                        æè¿°: ${shareContent.desc}<br>
                        <button onclick="window.open('${shareUrl}', '_blank')">ğŸ”— åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æµ‹è¯•</button>
                        <button onclick="navigator.clipboard.writeText('${shareUrl}').then(() => alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
                    </div>
                    <div class="url-output">åˆ†äº«é“¾æ¥: ${shareUrl}</div>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="test-error">âŒ é“¾æ¥ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
            }
        };

        window.testWechatDetection = function() {
            const resultsDiv = document.getElementById('wechatResults');
            const isWechat = wechatShare.isWechatBrowser();
            const userAgent = navigator.userAgent;

            resultsDiv.innerHTML = `
                <div class="test-result">
                    <strong>ç¯å¢ƒæ£€æµ‹ç»“æœ</strong><br>
                    å¾®ä¿¡ç¯å¢ƒ: ${isWechat ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
                    User Agent: <small>${userAgent}</small>
                </div>
            `;
        };

        // é¡µé¢åŠ è½½å®Œæˆæç¤º
        console.log('ğŸ‰ åˆ†äº«åŠŸèƒ½æµ‹è¯•é¡µé¢å·²å‡†å¤‡å°±ç»ª');
        console.log('ğŸ’¡ æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—');
    </script>
</body>
</html>